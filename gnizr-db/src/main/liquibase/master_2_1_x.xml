<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog logicalFilePath="classpath:/master_2_1_x.xml"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
				   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

	<changeSet id="sp-user" author="vrebesbyrd@gmail.com">
		<sql splitStatements="false">
            --------------------------------------------------------------
            -- PROCEDURE: getUser(id)
            -- INPUT: id INTEGER
            -- OUTPUT: NONE
            CREATE OR REPLACE FUNCTION getUser(uid INTEGER) RETURNS refcursor AS $c$
            DECLARE
              ref refcursor;
            BEGIN
              OPEN ref FOR SELECT * FROM "user" as U WHERE U.id=uid;
              RETURN ref;
            END;
            $c$ LANGUAGE plpgsql;

            --------------------------------------------------------------
            -- PROCEDURE: findUserUsername
            -- INPUT: username
            -- OUTPUT: NONE
            CREATE OR REPLACE FUNCTION findUserUsername(username VARCHAR(45)) RETURNS refcursor AS $c$
            DECLARE
              ref refcursor;
            BEGIN
              OPEN ref FOR SELECT * FROM "user" as U WHERE U.username=username;
              RETURN ref;
            END;
            $c$ LANGUAGE plpgsql;

            --------------------------------------------------------------
            -- PROCEDURE: findAllUsers
            -- INPUT: NONE
            -- OUTPUT: NONE
            CREATE OR REPLACE FUNCTION findAllUsers() RETURNS refcursor AS $c$
            DECLARE
              ref refcursor;
            BEGIN
              OPEN ref FOR SELECT * FROM "user" as U WHERE U.username != "gnizr";
              RETURN ref;
            END;
            $c$ LANGUAGE plpgsql;

            --------------------------------------------------------------
            -- PROCEDURE: findUserUnamePwd
            -- INPUT: username
            --        password
            -- OUTPUT: NONE
            CREATE OR REPLACE FUNCTION findUserUnamePwd(username VARCHAR(45), password VARCHAR(45)) RETURNS refcursor AS $c$
            DECLARE
              ref refcursor;
            BEGIN
              OPEN ref FOR SELECT * FROM "user" as U WHERE U.username=username AND U.password=MD5(password);
            END;
            $c$ LANGUAGE plpgsql;

            --------------------------------------------------------------
            -- PROCEDURE: deleteUser
            -- INPUT: uid
            -- OUTPUT NONE
            CREATE OR REPLACE FUNCTION deleteUser(uid INTEGER) RETURNS void AS $c$
            BEGIN
              DELETE U, bookmark, search_idx
              FROM "user" as U LEFT JOIN (bookmark, search_idx) ON (U.id = bookmark.user_id AND bookmark.id = search_idx.bookmark_id)
              WHERE U.id=uid;
            END;
            $c$ LANGUAGE plpgsql;

        </sql>
	</changeSet>

</databaseChangeLog>